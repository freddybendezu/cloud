<?xml version="1.0" encoding="utf-8"?>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    xmlns:dp="http://www.datapower.com/extensions"
    xmlns:env="http://schemas.xmlsoap.org/soap/envelope"
    extension-element-prefixes="dp" 
    exclude-result-prefixes="dp" version="1.0">

  <xsl:output method="xml"/>
  <xsl:template match="/">
    <xsl:variable name="mqData" select="document('local:///mqrc-codes.xml')"/>
    <xsl:variable name="mqrc" select="dp:response-header('x-dp-response-code')"/> 
    <xsl:variable name="errorCode" select="dp:variable('var://service/error-code')"/>
    <xsl:variable name="mqrc2" select="normalize-space($mqrc)"/>
    <xsl:variable name="mqrc3" select="string-length($mqrc2)"/>
    <xsl:choose>
      <xsl:when test="(starts-with($mqrc, '2') and ($mqrc3 = 4))">
        <xsl:variable name="mq-msg" select="$mqData/mqrc-codes/mqrc[@code=$mqrc]/@error-msg"/>
        <xsl:message dp:priority="error">
          <xsl:value-of select="concat(' ** MQ Reason Code (mqrc) ** : ',$mq-msg)"/>
        </xsl:message>
        <!-- set the error-protocol-response code to 200 if the client is HTTP -->
        <dp:set-variable name="'var://service/error-protocol-response'" value="'200'"/>
        <dp:set-http-response-header name="'x-dp-response-code'" value="'200 OK'"/>
        <xsl:variable name="response-url">
          <dp:url-open target="dpmq://DP2/?ReplyQueue=MQ4" response="xml"/>
        </xsl:variable>
        <xsl:copy-of select="$response-url"/>
      </xsl:when>
      <xsl:otherwise>
        <!-- set the error-protocol-response code to 200 if the client is HTTP -->
        <dp:set-variable name="'var://service/error-protocol-response'" value="'200'"/>
        <dp:set-http-response-header name="'x-dp-response-code'" value="'200 OK'"/>
        <env:Envelope>
          <env:Body>
            <env:error>
              <xsl:value-of select="concat(' ** MQ Reason Code (mqrc) ** : ',$mqrc)"/>
            </env:error>
          </env:Body>
        </env:Envelope>
      </xsl:otherwise>
    </xsl:choose>
  </xsl:template>
</xsl:stylesheet>